<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IT Ticket - Admin Dashboard</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<style>
body{
    margin:0;
    font-family:Inter,sans-serif;
    background:#f1f5f9;
    color:#0f172a;
}

header{
    background:#0f172a;
    color:white;
    padding:18px;
    text-align:center;
    font-weight:600;
    font-size:18px;
}

.container{ padding:20px; }

.kpi-grid{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
    gap:16px;
    margin-bottom:20px;
}

.kpi{
    background:white;
    border-radius:16px;
    padding:18px;
    box-shadow:0 6px 18px rgba(0,0,0,0.08);
}

.kpi h4{
    margin:0;
    font-size:12px;
    text-transform:uppercase;
    color:#64748b;
}

.kpi .value{
    margin-top:8px;
    font-size:24px;
    font-weight:700;
}

.card{
    background:white;
    border-radius:16px;
    padding:20px;
    box-shadow:0 6px 18px rgba(0,0,0,0.08);
}

table{
    width:100%;
    border-collapse:collapse;
    font-size:14px;
}

th,td{
    padding:12px;
    border-bottom:1px solid #e2e8f0;
}

th{
    background:#f8fafc;
    font-size:12px;
    text-transform:uppercase;
}

tr:hover{ background:#f8fafc; }

.badge{
    padding:6px 10px;
    border-radius:20px;
    font-size:12px;
    font-weight:600;
    cursor:pointer;
}

.badge.aperto{
    background:#fee2e2;
    color:#991b1b;
}

.badge.in_lavorazione{
    background:#fef9c3;
    color:#92400e;
}

.badge.chiuso{
    background:#dcfce7;
    color:#166534;
}

.status{
    margin-bottom:15px;
    font-size:14px;
    color:#475569;
}
</style>
</head>

<body>

<header>IT Ticket - Admin Dashboard</header>

<div class="container">

<div class="kpi-grid">
    <div class="kpi">
        <h4>Totale</h4>
        <div class="value" id="kpiTotal">0</div>
    </div>
    <div class="kpi">
        <h4>Aperti</h4>
        <div class="value" id="kpiOpen">0</div>
    </div>
    <div class="kpi">
        <h4>In Lavorazione</h4>
        <div class="value" id="kpiWorking">0</div>
    </div>
    <div class="kpi">
        <h4>Chiusi</h4>
        <div class="value" id="kpiClosed">0</div>
    </div>
</div>

<div class="card">
<div class="status" id="status">Caricamento...</div>
<table>
<thead>
<tr>
<th>ID</th>
<th>Data</th>
<th>User</th>
<th>Problema</th>
<th>Stato</th>
</tr>
</thead>
<tbody id="tableBody"></tbody>
</table>
</div>
</div>

<script>

/* CONFIG */
const DROPBOX_APP_KEY = "djxi8x2gj3ss38l";
const DROPBOX_FOLDER = "";
const REDIRECT_URI = "https://evotechlab.github.io/ticketmanager/";

/* TOKEN */
let accessToken = localStorage.getItem("db_access");
let refreshToken = localStorage.getItem("db_refresh");

function generateRandomString(length){
    const chars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
    let result="";
    for(let i=0;i<length;i++) result+=chars.charAt(Math.floor(Math.random()*chars.length));
    return result;
}

async function sha256base64url(str){
    const encoder=new TextEncoder();
    const data=encoder.encode(str);
    const hash=await crypto.subtle.digest("SHA-256",data);
    return btoa(String.fromCharCode(...new Uint8Array(hash)))
        .replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"");
}

async function initDropboxAuth(){

    const params=new URLSearchParams(window.location.search);
    const code=params.get("code");

    if(code && !accessToken){

        const codeVerifier=sessionStorage.getItem("pkce_code_verifier");

        const response=await fetch("https://api.dropboxapi.com/oauth2/token",{
            method:"POST",
            headers:{"Content-Type":"application/x-www-form-urlencoded"},
            body:new URLSearchParams({
                code,
                grant_type:"authorization_code",
                client_id:DROPBOX_APP_KEY,
                redirect_uri:REDIRECT_URI,
                code_verifier:codeVerifier
            })
        });

        const data=await response.json();

        accessToken=data.access_token;
        refreshToken=data.refresh_token;

        localStorage.setItem("db_access",accessToken);
        localStorage.setItem("db_refresh",refreshToken);

        window.history.replaceState({},document.title,REDIRECT_URI);
    }

    if(!accessToken && !refreshToken){

        const codeVerifier=generateRandomString(64);
        const codeChallenge=await sha256base64url(codeVerifier);
        sessionStorage.setItem("pkce_code_verifier",codeVerifier);

        const authUrl=
            `https://www.dropbox.com/oauth2/authorize?client_id=${DROPBOX_APP_KEY}&response_type=code&token_access_type=offline&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&code_challenge=${codeChallenge}&code_challenge_method=S256`;

        window.location.href=authUrl;
    }
}

async function refreshAccessToken(){
    const response=await fetch("https://api.dropboxapi.com/oauth2/token",{
        method:"POST",
        headers:{"Content-Type":"application/x-www-form-urlencoded"},
        body:new URLSearchParams({
            grant_type:"refresh_token",
            refresh_token:refreshToken,
            client_id:DROPBOX_APP_KEY
        })
    });
    const data=await response.json();
    accessToken=data.access_token;
    localStorage.setItem("db_access",accessToken);
}

async function dropboxFetch(url,options={}){
    options.headers=options.headers||{};
    options.headers["Authorization"]="Bearer "+accessToken;

    let response=await fetch(url,options);

    if(response.status===401 && refreshToken){
        await refreshAccessToken();
        options.headers["Authorization"]="Bearer "+accessToken;
        response=await fetch(url,options);
    }

    return response;
}

let tickets=[];

async function updateData(){

    document.getElementById("status").innerText="Aggiornamento...";

    const response=await dropboxFetch(
        "https://api.dropboxapi.com/2/files/list_folder",
        {
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body:JSON.stringify({path:DROPBOX_FOLDER})
        }
    );

    const data=await response.json();
    tickets=[];

    for(const file of data.entries){
        if(file[".tag"]!=="file") continue;

        const res=await dropboxFetch(
            "https://content.dropboxapi.com/2/files/download",
            {
                method:"POST",
                headers:{
                    "Dropbox-API-Arg":JSON.stringify({path:file.path_lower})
                }
            }
        );

        const ticket=await res.json();
        tickets.push(ticket);
    }

    renderDashboard();
}

function renderDashboard(){

    tickets.sort((a,b)=>new Date(b.timestamp)-new Date(a.timestamp));

    let open=0,work=0,closed=0;

    tickets.forEach(t=>{
        if(t.stato==="aperto") open++;
        else if(t.stato==="in_lavorazione") work++;
        else if(t.stato==="chiuso") closed++;
    });

    document.getElementById("kpiTotal").innerText=tickets.length;
    document.getElementById("kpiOpen").innerText=open;
    document.getElementById("kpiWorking").innerText=work;
    document.getElementById("kpiClosed").innerText=closed;

    const tbody=document.getElementById("tableBody");
    tbody.innerHTML="";

    tickets.forEach(t=>{
        tbody.innerHTML+=`
        <tr>
            <td>${t.id}</td>
            <td>${new Date(t.timestamp).toLocaleDateString()}</td>
            <td>${t.user}</td>
            <td>${t.problema}</td>
            <td>
                <span class="badge ${t.stato}" onclick="cycleStatus('${t.id}')">
                    ${t.stato.replace("_"," ").toUpperCase()}
                </span>
            </td>
        </tr>`;
    });

    document.getElementById("status").innerText=
        "Ultimo aggiornamento: "+new Date().toLocaleTimeString();
}

async function cycleStatus(id){

    const ticket=tickets.find(t=>t.id===id);

    if(ticket.stato==="aperto") ticket.stato="in_lavorazione";
    else if(ticket.stato==="in_lavorazione") ticket.stato="chiuso";
    else ticket.stato="aperto";

    await dropboxFetch(
        "https://content.dropboxapi.com/2/files/upload",
        {
            method:"POST",
            headers:{
                "Content-Type":"application/octet-stream",
                "Dropbox-API-Arg":JSON.stringify({
                    path:`${DROPBOX_FOLDER}/ticket_${id}.json`,
                    mode:"overwrite"
                })
            },
            body:JSON.stringify(ticket)
        }
    );

    updateData();
}

async function init(){
    await initDropboxAuth();
    await updateData();
    setInterval(updateData,5000);
}

init();

</script>

</body>
</html>
