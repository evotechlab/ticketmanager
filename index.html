<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IT Ticket - Admin Dashboard</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{
margin:0;
font-family:Inter,sans-serif;
background:#f1f5f9;
color:#0f172a;
}

header{
background:#0f172a;
color:white;
padding:18px;
text-align:center;
font-weight:600;
font-size:18px;
transition:0.4s ease;
}

.container{ padding:20px; }

.kpi-grid{
display:grid;
grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
gap:16px;
margin-bottom:20px;
}

.kpi{
background:white;
border-radius:20px;
padding:20px;
box-shadow:0 12px 28px rgba(0,0,0,0.08);
}

.kpi h4{
margin:0;
font-size:12px;
text-transform:uppercase;
color:#64748b;
}

.kpi .value{
margin-top:8px;
font-size:24px;
font-weight:700;
}

.card{
background:white;
border-radius:20px;
padding:24px;
box-shadow:0 12px 28px rgba(0,0,0,0.08);
margin-bottom:20px;
}

table{
width:100%;
border-collapse:collapse;
font-size:14px;
}

th,td{
padding:12px;
border-bottom:1px solid #e2e8f0;
}

th{
background:#f8fafc;
font-size:12px;
text-transform:uppercase;
}

tr:hover{ background:#f8fafc; }

select,input{
padding:8px;
border-radius:8px;
border:1px solid #e2e8f0;
}

button{
padding:8px 14px;
border:none;
border-radius:8px;
background:#0ea5e9;
color:white;
cursor:pointer;
}

.status{
margin-bottom:15px;
font-size:14px;
color:#475569;
}

canvas{
max-height:220px !important;
}

</style>
</head>

<body>

<header>IT Ticket - Admin Dashboard</header>

<div class="container">

<div class="kpi-grid">
<div class="kpi"><h4>Totale</h4><div class="value" id="kpiTotal">0</div></div>
<div class="kpi"><h4>Aperti</h4><div class="value" id="kpiOpen">0</div></div>
<div class="kpi"><h4>In Lavorazione</h4><div class="value" id="kpiWorking">0</div></div>
<div class="kpi"><h4>Chiusi</h4><div class="value" id="kpiClosed">0</div></div>
</div>

<div class="card">
<h3>Analytics</h3>
<canvas id="statusChart"></canvas>
</div>

<div class="card">
<div style="display:flex;gap:10px;flex-wrap:wrap;">
<input id="searchInput" placeholder="ðŸ”Ž Ricerca globale..." style="flex:1;">
<select id="statusFilter">
<option value="">Tutti</option>
<option value="aperto">Aperti</option>
<option value="in_lavorazione">In Lavorazione</option>
<option value="chiuso">Chiusi</option>
</select>
<button onclick="exportPDF()">ðŸ“„ Export PDF</button>
</div>
</div>

<div class="card">
<div class="status" id="status">Caricamento...</div>
<table>
<thead>
<tr>
<th>ID</th>
<th>Data</th>
<th>User</th>
<th>Problema</th>
<th>Stato</th>
</tr>
</thead>
<tbody id="tableBody"></tbody>
</table>
</div>



</div>

<script>

/* ================= CONFIG ================= */

const DROPBOX_APP_KEY="djxi8x2gj3ss38l";
const DROPBOX_FOLDER="/tickets";
const REDIRECT_URI="https://evotechlab.github.io/ticketmanager/";

let accessToken=localStorage.getItem("db_access");
let refreshToken=localStorage.getItem("db_refresh");

let tickets=[];
let previousTicketIds=new Set();
let firstLoad=true;
let chart;

/* ================= AUTH ================= */

async function refreshAccessToken(){
const response=await fetch("https://api.dropboxapi.com/oauth2/token",{
method:"POST",
headers:{"Content-Type":"application/x-www-form-urlencoded"},
body:new URLSearchParams({
grant_type:"refresh_token",
refresh_token:refreshToken,
client_id:DROPBOX_APP_KEY
})
});
const data=await response.json();
accessToken=data.access_token;
localStorage.setItem("db_access",accessToken);
}

async function dropboxFetch(url,options={}){
options.headers=options.headers||{};
options.headers["Authorization"]="Bearer "+accessToken;
let response=await fetch(url,options);
if(response.status===401 && refreshToken){
await refreshAccessToken();
options.headers["Authorization"]="Bearer "+accessToken;
response=await fetch(url,options);
}
return response;
}

/* ================= LOAD ================= */

async function updateData(){

document.getElementById("status").innerText="Aggiornamento...";

const response=await dropboxFetch(
"https://api.dropboxapi.com/2/files/list_folder",
{
method:"POST",
headers:{"Content-Type":"application/json"},
body:JSON.stringify({path:DROPBOX_FOLDER})
}
);

const data=await response.json();

const ticketFiles=data.entries.filter(f=>f[".tag"]==="file" && f.name.startsWith("ticket_"));

tickets=await Promise.all(ticketFiles.map(async file=>{
const res=await dropboxFetch(
"https://content.dropboxapi.com/2/files/download",
{
method:"POST",
headers:{"Dropbox-API-Arg":JSON.stringify({path:file.path_lower})}
}
);
return await res.json();
}));

const currentIds=new Set(tickets.map(t=>t.id));

if(!firstLoad){
currentIds.forEach(id=>{
if(!previousTicketIds.has(id)){
playNewTicketSound();
}
});
}

previousTicketIds=currentIds;
firstLoad=false;

renderDashboard();
}

/* ================= RENDER ================= */

function renderDashboard(){

const search=document.getElementById("searchInput").value.toLowerCase();
const filter=document.getElementById("statusFilter").value;

let filtered=tickets.filter(t=>{
const matchSearch=t.user.toLowerCase().includes(search)||
t.problema.toLowerCase().includes(search)||
t.id.includes(search);
const matchStatus=filter? t.stato===filter:true;
return matchSearch && matchStatus;
});

filtered.sort((a,b)=>new Date(b.timestamp)-new Date(a.timestamp));

let open=0,work=0,closed=0;

filtered.forEach(t=>{
if(t.stato==="aperto") open++;
else if(t.stato==="in_lavorazione") work++;
else if(t.stato==="chiuso") closed++;
});

document.getElementById("kpiTotal").innerText=tickets.length;
document.getElementById("kpiOpen").innerText=open;
document.getElementById("kpiWorking").innerText=work;
document.getElementById("kpiClosed").innerText=closed;

const tbody=document.getElementById("tableBody");
tbody.innerHTML="";

filtered.forEach(t=>{
tbody.innerHTML+=`
<tr>
<td>${t.id}</td>
<td>${new Date(t.timestamp).toLocaleDateString()}</td>
<td>${t.user}</td>
<td>${t.problema}</td>
<td>
<select onchange="changeStatus('${t.id}',this.value)">
<option value="aperto" ${t.stato==="aperto"?"selected":""}>APERTO</option>
<option value="in_lavorazione" ${t.stato==="in_lavorazione"?"selected":""}>IN LAVORAZIONE</option>
<option value="chiuso" ${t.stato==="chiuso"?"selected":""}>CHIUSO</option>
</select>
</td>
</tr>`;
});

updateChart(open,work,closed);

document.getElementById("status").innerText="Ultimo aggiornamento: "+new Date().toLocaleTimeString();
}

/* ================= STATUS SYNC FIX ================= */

async function changeStatus(id,newStatus){

const ticket=tickets.find(t=>t.id===id);
if(!ticket) return;

ticket.stato=newStatus;

/* update ticket file */
await dropboxFetch(
"https://content.dropboxapi.com/2/files/upload",
{
method:"POST",
headers:{
"Content-Type":"application/octet-stream",
"Dropbox-API-Arg":JSON.stringify({
path:`${DROPBOX_FOLDER}/ticket_${id}.json`,
mode:"overwrite"
})
},
body:JSON.stringify(ticket)
}
);

/* update user history file */
const userFile=`${DROPBOX_FOLDER}/user_${ticket.user.toLowerCase().replace(/\s+/g,"_")}.json`;

const res=await dropboxFetch(
"https://content.dropboxapi.com/2/files/download",
{
method:"POST",
headers:{"Dropbox-API-Arg":JSON.stringify({path:userFile})}
}
);

if(res.status===200){
const history=await res.json();
const index=history.tickets.findIndex(t=>t.id===id);
if(index!==-1){
history.tickets[index].stato=newStatus;

await dropboxFetch(
"https://content.dropboxapi.com/2/files/upload",
{
method:"POST",
headers:{
"Content-Type":"application/octet-stream",
"Dropbox-API-Arg":JSON.stringify({
path:userFile,
mode:"overwrite"
})
},
body:JSON.stringify(history)
}
);
}
}

renderDashboard();
}

/* ================= CHART ================= */

function updateChart(open,work,closed){

const ctx=document.getElementById("statusChart");

if(chart) chart.destroy();

chart=new Chart(ctx,{
type:'doughnut',
data:{
labels:['Aperti','In Lavorazione','Chiusi'],
datasets:[{
data:[open,work,closed],
backgroundColor:['#ef4444','#facc15','#22c55e']
}]
},
options:{
responsive:true,
maintainAspectRatio:false,
plugins:{legend:{position:'bottom'}}
}
});
}

/* ================= AUDIO ================= */

let audioContext = null;

// crea contesto SOLO su interazione reale
function enableAudio() {
    if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
    }
}

// sblocca al primo click reale
window.addEventListener("pointerdown", () => {
    enableAudio();
}, { once: true });

function playNewTicketSound() {

    if (!audioContext) return; // se non ancora attivato

    if (audioContext.state === "suspended") {
        audioContext.resume();
    }

    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();

    oscillator.type = "sine";
    oscillator.frequency.value = 880;
    gainNode.gain.value = 0.3;

    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);

    oscillator.start();
    oscillator.stop(audioContext.currentTime + 0.25);

    // Effetto visivo
    const header = document.querySelector("header");
    header.style.background = "#16a34a";
    setTimeout(() => {
        header.style.background = "#0f172a";
    }, 1200);
}



/* ================= PDF ================= */

async function exportPDF(){
const { jsPDF }=window.jspdf;
const doc=new jsPDF();
doc.text("IT Ticket Audit Report",14,15);
let y=25;
tickets.forEach(t=>{
doc.text(`${t.id} | ${t.user} | ${t.stato} | ${t.problema}`,14,y);
y+=6;
if(y>280){doc.addPage();y=20;}
});
doc.save("ticket_audit_report.pdf");
}

/* ================= INIT ================= */

document.getElementById("searchInput").addEventListener("input",renderDashboard);
document.getElementById("statusFilter").addEventListener("change",renderDashboard);

setInterval(updateData,8000);
updateData();

</script>

</body>
</html>


